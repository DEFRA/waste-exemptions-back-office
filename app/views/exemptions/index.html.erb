<%= render("waste_exemptions_engine/shared/back", back_path: root_path) %>
<h1 class="govuk-heading-l"><%= t('.heading') %></h1>
<%= form_with(url: exemptions_path, method: :put, local: true) do |f| %>
  <% if flash[:message].present? || flash[:error].present? %>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <%= render("shared/message", message: flash[:message]) if flash[:message].present? %>
        <%= render("shared/error", error: flash[:error], details: flash[:error_details]) if flash[:error].present? %>
      </div>
    </div>
  <% end %>
  <table class="govuk-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header">Exemptions</th>
        <th class="govuk-table__header">Band</th>
        <% @buckets.each do |bucket| %>
          <th class="govuk-table__header bucket_name"><%= bucket.name %></th>
        <% end %>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
      <% @exemptions.each do |exemption, index| %>
        <tr class="govuk-table__row">
          <td class="govuk-table__cell"><%= "#{exemption.code} #{exemption.summary}" %></td>
          <td class="govuk-table__cell">
            <%= f.label "exemptions_#{exemption.id}_band_id", 'Band', class: 'govuk-visually-hidden' %>
            <%= f.select "exemptions[#{exemption.id}][band_id]", options_from_collection_for_select(@bands, :id, :name, exemption.band_id), {}, id: "exemptions_#{exemption.id}_band_id", class: "govuk-select" %>
          </td>
          <% @buckets.each do |bucket| %>
            <td class="govuk-table__cell checkbox_cell">
              <div class="govuk-checkboxes__item">
                <%= f.check_box "exemptions[#{exemption.id}][bucket_ids][]", { multiple: false, class: "govuk-checkboxes__input", id: "exemptions_#{exemption.id}_bucket_ids_#{bucket.id}", checked: exemption.bucket_exemptions.any? { |be| be.bucket_id == bucket.id } }, bucket.id, nil %>
                <%= f.label "exemptions_#{exemption.id}_bucket_ids_#{bucket.id}", class: "govuk-checkboxes__label" do %>
                  <span class="govuk-visually-hidden"><%= bucket.name %></span>
                <% end %>
              </div>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
  <%= f.submit t('.submit'), class: "govuk-button" %>
<% end %>
