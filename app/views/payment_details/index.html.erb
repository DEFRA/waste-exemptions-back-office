<% content_for :title, t(".title", reference: @resource.reference) %>

<%= render("waste_exemptions_engine/shared/back", back_path: registration_path(@resource.reference)) %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">
      <%= t(".heading", reference: @resource.reference) %>
    </h1>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h2 class="govuk-heading-m">
      <%= t(".details_section.charges.heading") %>
    </h2>
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th class="govuk-table__header">
            <%= t(".details_section.charges.headers.date") %>
          </th>
          <th class="govuk-table__header">
            <%= t(".details_section.charges.headers.breakdown") %>
          </th>
          <th class="govuk-table__header govuk-!-text-align-right">
            <%= t(".details_section.charges.headers.amount") %>
          </th>
        </tr>
      </thead>
      <tbody>
        <% @presenter.sorted_orders.each do |order| %>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">
              <%= order.created_at.strftime("%Y-%m-%d") %>
            </td>
            <td class="govuk-table__cell">
              <% if order.exemption_codes_excluding_bucket.present? %>
                <%= order.exemption_codes_excluding_bucket %> <br>
              <% end %>
              <% if order.bucket.present? %>
                <%= t(".details_section.charges.bucket_exemptions_label.#{order.bucket.bucket_type}") %> 
                <%= order.bucket_exemption_codes %> <br>
              <% end %>
              <%= t(".details_section.charges.registration_charge_label") %> <br>
              <%= t(".details_section.charges.total_charge_label") %>
            </td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              <% if order.exemption_codes_excluding_bucket.present? %>
                <%= display_pence_as_pounds_sterling_and_pence(pence: (order.charge_detail&.total_compliance_charge_amount_excluding_bucket)) %> <br>
              <% end %>
              <% if order.bucket.present? %>
                <%= display_pence_as_pounds_sterling_and_pence(pence: order.charge_detail&.bucket_charge_amount) %> <br>
              <% end %>
              <%= display_pence_as_pounds_sterling_and_pence(pence: order.charge_detail&.registration_charge_amount) %> <br>
              <%= display_pence_as_pounds_sterling_and_pence(pence: order.charge_detail&.total_charge_amount) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <h2 class="govuk-heading-m">
      <%= t(".details_section.charge_adjustments.heading") %>
    </h2>
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th class="govuk-table__header">
            <%= t(".details_section.charge_adjustments.headers.date") %>
          </th>
          <th class="govuk-table__header">
            <%= t(".details_section.charge_adjustments.headers.type") %>
          </th>
          <th class="govuk-table__header">
            <%= t(".details_section.charge_adjustments.headers.comments") %>
          </th>
          <th class="govuk-table__header govuk-!-text-align-right">
            <%= t(".details_section.charge_adjustments.headers.amount") %>
          </th>
        </tr>
      </thead>
      <tbody>
        <% @presenter.charge_adjustments.each do |adjustment| %>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">
              <%= adjustment.created_at %>
            </td>
            <td class="govuk-table__cell">
              <%= adjustment.adjustment_type %>
            </td>
            <td class="govuk-table__cell">
              <%= adjustment.reason %>
            </td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              <%= adjustment.amount %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <h2 class="govuk-heading-m">
      <%= t(".details_section.payments.heading") %>
    </h2>
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th class="govuk-table__header"><%= t(".details_section.payments.headers.date") %></th>
          <th class="govuk-table__header"><%= t(".details_section.payments.headers.reference") %></th>
          <th class="govuk-table__header"><%= t(".details_section.payments.headers.type") %></th>
          <th class="govuk-table__header govuk-!-text-align-right"><%= t(".details_section.payments.headers.amount") %></th>
        </tr>
      </thead>
      <tbody>
        <% @presenter.successful_payments.each do |payment| %>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell"><%= format_date(payment.date_time) %></td>
            <td class="govuk-table__cell"><%= payment.reference %></td>
            <td class="govuk-table__cell">
              <%= payment.payment_type %>
            </td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              <%= payment.payment_amount %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <h2 class="govuk-heading-m">
      <%= t(".details_section.refunds.heading") %>
    </h2>
    <table class="govuk-table">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th class="govuk-table__header"><%= t(".details_section.refunds.headers.date") %></th>
          <th class="govuk-table__header"><%= t(".details_section.refunds.headers.reference") %></th>
          <th class="govuk-table__header"><%= t(".details_section.refunds.headers.comments") %></th>
          <th class="govuk-table__header govuk-!-text-align-right"><%= t(".details_section.refunds.headers.amount") %></th>
        </tr>
      </thead>
      <tbody>
        <% @presenter.refunds_and_reversals.each do |payment| %>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell"><%= format_date(payment.created_at) %></td>
            <td class="govuk-table__cell"><%= payment.reference %></td>
            <td class="govuk-table__cell"><%= payment.comments %></td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              <%= payment.payment_amount %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <h2 class="govuk-heading-m">
      <%= t(".details_section.balance.heading") %>
    </h2>
    <table class="govuk-table">
      <thead class="govuk-table__head govuk-visually-hidden">
        <tr class="govuk-table__row">
          <th class="govuk-table__header">
            <%= t(".details_section.balance.heading") %>
          </th>
          <th class="govuk-table__header">
            <%= t(".details_section.balance.amount") %>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr class="govuk-table__row">
          <td class="govuk-table__cell govuk-!-font-weight-bold">
            <%= t(".details_section.balance.amount") %>
          </td>
          <td class="govuk-table__cell govuk-!-text-align-right" id="balance">
            <%= @presenter.balance %>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="govuk-grid-column-one-third">
    <h2 class="govuk-heading-m">
      <%= t(".actions_section.heading", reference: @resource.reference) %>
    </h2>

    <% if can?(:add_payment, @resource) %>
    <p class="govuk-body">
      <%= link_to(t(".actions_section.add_payment"),
                registration_add_payment_path(reference: @resource.reference)) %>
    </p>
    <% end %>

    <% if can?(:refund_payment, @resource) && can_display_refund_link?(@resource) %>
      <p class="govuk-body">
      <%= link_to t(".actions_section.links.record_refund"),
        registration_record_refunds_path(registration_reference: @resource.reference) %>
      </p>
    <% end %>

    <% if can?(:reverse_payment, @resource) && can_display_reversal_link?(@resource) %>
      <p class="govuk-body">
      <%= link_to t(".actions_section.links.reverse_payment"),
        registration_record_reversals_path(registration_reference: @resource.reference) %>
      </p>
    <% end %>

    <% if can?(:add_charge_adjustment, @resource) %>
      <p class="govuk-body">
      <%= link_to t(".actions_section.links.charge_adjustment"),
        new_registration_adjustment_type_path(registration_reference: @resource.reference) %>
      </p>
    <% end %>
  </div>
</div>
